{% extends "base.html" %}

{% block title %}整合投資分析 - 三層聯動系統{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- 頁面標題 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h2 class="mb-0">
                        <i class="fas fa-rocket me-2"></i>
                        整合投資分析系統
                        <small class="float-end">三層聯動 · 一鍵分析</small>
                    </h2>
                </div>
                <div class="card-body">
                    <p class="lead mb-0">
                        <i class="fas fa-info-circle text-info me-2"></i>
                        基於總經環境自動選股，無需手動操作每一層級。系統將自動執行三層分析並提供最終投資建議。
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- 分析控制區 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs me-2"></i>
                        分析設定
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <label for="riskTolerance" class="form-label">風險偏好</label>
                            <select class="form-select" id="riskTolerance">
                                <option value="auto">自動判斷（推薦）</option>
                                <option value="conservative">保守型</option>
                                <option value="moderate">穩健型</option>
                                <option value="aggressive">積極型</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="investmentAmount" class="form-label">投資金額（美元）</label>
                            <input type="number" class="form-control" id="investmentAmount" 
                                   placeholder="例如：10000" min="1000" step="1000">
                        </div>
                        <div class="col-md-4">
                            <label for="timeHorizon" class="form-label">投資期間</label>
                            <select class="form-select" id="timeHorizon">
                                <option value="short">短期（1-3個月）</option>
                                <option value="medium" selected>中期（3-12個月）</option>
                                <option value="long">長期（1年以上）</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12 text-center">
                            <button class="btn btn-primary btn-lg" onclick="startIntegratedAnalysis()">
                                <i class="fas fa-play me-2"></i>
                                開始三層聯動分析
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 分析進度 -->
    <div class="row mb-4" id="progressSection" style="display: none;">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        分析進度
                    </h5>
                </div>
                <div class="card-body">
                    <div class="progress mb-3" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             id="progressBar" role="progressbar" style="width: 0%">
                            0%
                        </div>
                    </div>
                    <div id="progressText" class="text-center">
                        準備開始分析...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 分析結果 -->
    <div class="row" id="resultsSection" style="display: none;">
        <!-- 執行摘要 -->
        <div class="col-12 mb-4">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        投資建議摘要
                    </h4>
                </div>
                <div class="card-body" id="executiveSummary">
                    <!-- 動態內容 -->
                </div>
            </div>
        </div>

        <!-- 推薦股票 -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-star me-2"></i>
                        推薦股票組合
                    </h5>
                </div>
                <div class="card-body" id="recommendedStocks">
                    <!-- 動態內容 -->
                </div>
            </div>
        </div>

        <!-- 三層分析詳情 -->
        <div class="col-12">
            <div class="accordion" id="analysisAccordion">
                <!-- 第一層：總經環境 -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="layer1Header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" 
                                data-bs-target="#layer1Collapse">
                            <i class="fas fa-globe me-2"></i>
                            第一層：總經環境分析
                        </button>
                    </h2>
                    <div id="layer1Collapse" class="accordion-collapse collapse show" 
                         data-bs-parent="#analysisAccordion">
                        <div class="accordion-body" id="layer1Details">
                            <!-- 動態內容 -->
                        </div>
                    </div>
                </div>

                <!-- 第二層：策略選股 -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="layer2Header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                data-bs-target="#layer2Collapse">
                            <i class="fas fa-filter me-2"></i>
                            第二層：策略選股分析
                        </button>
                    </h2>
                    <div id="layer2Collapse" class="accordion-collapse collapse" 
                         data-bs-parent="#analysisAccordion">
                        <div class="accordion-body" id="layer2Details">
                            <!-- 動態內容 -->
                        </div>
                    </div>
                </div>

                <!-- 第三層：技術確認 -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="layer3Header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                data-bs-target="#layer3Collapse">
                            <i class="fas fa-chart-bar me-2"></i>
                            第三層：技術確認分析
                        </button>
                    </h2>
                    <div id="layer3Collapse" class="accordion-collapse collapse" 
                         data-bs-parent="#analysisAccordion">
                        <div class="accordion-body" id="layer3Details">
                            <!-- 動態內容 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 錯誤訊息 -->
    <div class="row" id="errorSection" style="display: none;">
        <div class="col-12">
            <div class="alert alert-danger" role="alert">
                <h4 class="alert-heading">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    分析失敗
                </h4>
                <p id="errorMessage">發生未知錯誤，請稍後重試。</p>
                <hr>
                <p class="mb-0">
                    <button class="btn btn-outline-danger" onclick="location.reload()">
                        <i class="fas fa-redo me-2"></i>
                        重新載入頁面
                    </button>
                </p>
            </div>
        </div>
    </div>
</div>

<script>
let analysisInProgress = false;

function startIntegratedAnalysis() {
    if (analysisInProgress) {
        alert('分析正在進行中，請稍候...');
        return;
    }

    // 收集用戶偏好
    const userPreferences = {
        risk_tolerance: document.getElementById('riskTolerance').value,
        investment_amount: parseFloat(document.getElementById('investmentAmount').value) || 10000,
        time_horizon: document.getElementById('timeHorizon').value
    };

    // 隱藏之前的結果
    document.getElementById('resultsSection').style.display = 'none';
    document.getElementById('errorSection').style.display = 'none';
    
    // 顯示進度
    document.getElementById('progressSection').style.display = 'block';
    
    analysisInProgress = true;
    
    // 模擬進度更新
    updateProgress(10, '正在分析總經環境...');
    
    // 發送分析請求
    fetch('/api/integrated-analysis', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(userPreferences)
    })
    .then(response => {
        updateProgress(50, '正在進行動態選股...');
        return response.json();
    })
    .then(data => {
        updateProgress(80, '正在進行技術確認...');
        
        setTimeout(() => {
            updateProgress(100, '分析完成！');
            
            setTimeout(() => {
                analysisInProgress = false;
                document.getElementById('progressSection').style.display = 'none';
                
                if (data.success) {
                    displayResults(data);
                } else {
                    displayError(data.message || data.error || '分析失敗');
                }
            }, 1000);
        }, 1000);
    })
    .catch(error => {
        console.error('分析錯誤:', error);
        analysisInProgress = false;
        document.getElementById('progressSection').style.display = 'none';
        displayError('網路錯誤或服務暫時不可用，請稍後重試。');
    });
}

function updateProgress(percentage, text) {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    progressBar.style.width = percentage + '%';
    progressBar.textContent = percentage + '%';
    progressText.textContent = text;
}

function displayResults(data) {
    // 顯示結果區域
    document.getElementById('resultsSection').style.display = 'block';
    
    // 顯示執行摘要
    displayExecutiveSummary(data.summary, data.investment_strategy);
    
    // 顯示推薦股票
    displayRecommendedStocks(data.final_recommendations.top_picks);
    
    // 顯示三層分析詳情
    displayLayer1Details(data.layer1_analysis);
    displayLayer2Details(data.layer2_analysis);
    displayLayer3Details(data.layer3_analysis);
}

function displayExecutiveSummary(summary, strategy) {
    const container = document.getElementById('executiveSummary');
    
    container.innerHTML = `
        <div class="row">
            <div class="col-md-3 text-center">
                <h3 class="text-primary">${summary.total_recommendations}</h3>
                <p class="text-muted">推薦股票</p>
            </div>
            <div class="col-md-3 text-center">
                <h3 class="text-success">${summary.strong_buy_count}</h3>
                <p class="text-muted">強烈推薦</p>
            </div>
            <div class="col-md-3 text-center">
                <h3 class="text-info">${summary.average_confidence}%</h3>
                <p class="text-muted">平均信心度</p>
            </div>
            <div class="col-md-3 text-center">
                <h3 class="text-warning">${strategy.primary_focus}</h3>
                <p class="text-muted">投資策略</p>
            </div>
        </div>
        <hr>
        <div class="row">
            <div class="col-12">
                <h5><i class="fas fa-lightbulb me-2"></i>關鍵訊息</h5>
                <p class="lead">${summary.key_message}</p>
                
                <h6><i class="fas fa-list me-2"></i>下一步行動</h6>
                <ul>
                    ${summary.next_steps.map(step => `<li>${step}</li>`).join('')}
                </ul>
                
                <h6><i class="fas fa-industry me-2"></i>主要產業</h6>
                <div>
                    ${summary.primary_sectors.map(sector => 
                        `<span class="badge bg-secondary me-2">${sector}</span>`
                    ).join('')}
                </div>
            </div>
        </div>
    `;
}

function displayRecommendedStocks(stocks) {
    const container = document.getElementById('recommendedStocks');
    
    if (!stocks || stocks.length === 0) {
        container.innerHTML = '<p class="text-muted">暫無推薦股票</p>';
        return;
    }
    
    let html = '<div class="row">';
    
    stocks.forEach((stock, index) => {
        const signalClass = getSignalClass(stock.trading_signal?.signal);
        const confidenceColor = getConfidenceColor(stock.trading_signal?.confidence || 0);
        
        html += `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card h-100 border-${signalClass}">
                    <div class="card-header bg-${signalClass} text-white">
                        <h6 class="mb-0">
                            #${index + 1} ${stock.symbol}
                            <span class="float-end badge bg-light text-dark">${stock.total_score}</span>
                        </h6>
                    </div>
                    <div class="card-body">
                        <h6 class="card-title">${stock.name}</h6>
                        <p class="card-text">
                            <strong>當前價格:</strong> $${stock.current_price}<br>
                            <strong>市值:</strong> ${stock.market_cap_formatted}<br>
                            <strong>產業:</strong> ${stock.sector}
                        </p>
                        <div class="mb-2">
                            <strong>交易信號:</strong> 
                            <span class="badge bg-${signalClass}">${stock.trading_signal?.signal || '觀望'}</span>
                        </div>
                        <div class="progress mb-2" style="height: 20px;">
                            <div class="progress-bar bg-${confidenceColor}" 
                                 style="width: ${stock.trading_signal?.confidence || 0}%">
                                信心度 ${stock.trading_signal?.confidence || 0}%
                            </div>
                        </div>
                        <small class="text-muted">
                            ${stock.selection_reasons?.slice(0, 2).join(', ') || '基於綜合評分選出'}
                        </small>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function displayLayer1Details(layer1) {
    const container = document.getElementById('layer1Details');
    
    container.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6><i class="fas fa-heart-pulse me-2"></i>市場情緒</h6>
                <div class="card mb-3">
                    <div class="card-body">
                        <h4 class="text-center">${layer1.market_sentiment.fear_greed_index}</h4>
                        <p class="text-center text-muted">${layer1.market_sentiment.sentiment_label}</p>
                        <p class="small">${layer1.market_sentiment.interpretation}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <h6><i class="fas fa-chart-line me-2"></i>經濟指標</h6>
                <div class="card mb-3">
                    <div class="card-body">
                        <p><strong>GDP成長:</strong> ${layer1.economic_indicators.gdp_growth}%</p>
                        <p><strong>失業率:</strong> ${layer1.economic_indicators.unemployment_rate}%</p>
                        <p><strong>通膨率:</strong> ${layer1.economic_indicators.inflation_rate}%</p>
                        <p><strong>經濟健康度:</strong> ${layer1.economic_indicators.economic_health}</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="alert alert-info">
                    <strong>市場階段:</strong> ${layer1.market_phase} | 
                    <strong>風險偏好:</strong> ${layer1.risk_appetite} | 
                    <strong>投資環境:</strong> ${layer1.investment_environment}
                </div>
            </div>
        </div>
    `;
}

function displayLayer2Details(layer2) {
    const container = document.getElementById('layer2Details');
    
    container.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6><i class="fas fa-strategy me-2"></i>選股策略</h6>
                <p><strong>策略類型:</strong> ${layer2.strategy_applied}</p>
                <p><strong>篩選股票數:</strong> ${layer2.total_screened}</p>
                <p><strong>通過篩選:</strong> ${layer2.selected_stocks?.length || 0}</p>
            </div>
            <div class="col-md-6">
                <h6><i class="fas fa-industry me-2"></i>產業分布</h6>
                <div>
                    ${Object.entries(layer2.sector_distribution || {}).map(([sector, count]) => 
                        `<span class="badge bg-primary me-2">${sector}: ${count}</span>`
                    ).join('')}
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6><i class="fas fa-filter me-2"></i>篩選條件</h6>
                <div class="card">
                    <div class="card-body">
                        <pre class="small">${JSON.stringify(layer2.screening_criteria, null, 2)}</pre>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function displayLayer3Details(layer3) {
    const container = document.getElementById('layer3Details');
    
    container.innerHTML = `
        <div class="row">
            <div class="col-md-4">
                <h6><i class="fas fa-chart-bar me-2"></i>技術分析</h6>
                <p>${layer3.technical_summary?.summary || '已完成技術指標分析'}</p>
            </div>
            <div class="col-md-4">
                <h6><i class="fas fa-shield-alt me-2"></i>風險評估</h6>
                <p>${layer3.risk_assessment?.assessment || '整體風險可控'}</p>
            </div>
            <div class="col-md-4">
                <h6><i class="fas fa-briefcase me-2"></i>組合建議</h6>
                <p>${layer3.portfolio_suggestions?.suggestion || '建議分散投資'}</p>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6><i class="fas fa-list me-2"></i>確認股票清單</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>股票</th>
                                <th>信號</th>
                                <th>信心度</th>
                                <th>目標價</th>
                                <th>停損價</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(layer3.confirmed_stocks || []).map(stock => `
                                <tr>
                                    <td>${stock.symbol}</td>
                                    <td><span class="badge bg-${getSignalClass(stock.trading_signal?.signal)}">${stock.trading_signal?.signal || '觀望'}</span></td>
                                    <td>${stock.trading_signal?.confidence || 0}%</td>
                                    <td>$${stock.final_recommendation?.target_price?.toFixed(2) || 'N/A'}</td>
                                    <td>$${stock.final_recommendation?.stop_loss?.toFixed(2) || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

function displayError(message) {
    document.getElementById('errorSection').style.display = 'block';
    document.getElementById('errorMessage').textContent = message;
}

function getSignalClass(signal) {
    switch(signal) {
        case '強烈買入': return 'success';
        case '買入': return 'primary';
        case '持有': return 'warning';
        case '賣出': return 'danger';
        default: return 'secondary';
    }
}

function getConfidenceColor(confidence) {
    if (confidence >= 80) return 'success';
    if (confidence >= 60) return 'info';
    if (confidence >= 40) return 'warning';
    return 'danger';
}
</script>
{% endblock %} 