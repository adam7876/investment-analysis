{% extends "base.html" %}

{% block title %}第二層：事件選股 - 美股投資分析系統{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12 text-center">
        <h2 class="mb-3">
            <i class="fas fa-newspaper text-warning me-2"></i>
            第二層：事件與產業選股
        </h2>
        <p class="lead text-muted">
            追蹤財經事件、新聞情緒和產業動態，發掘投資機會和風險
        </p>
        <div class="mb-4">
            <button id="collectLayer2Data" class="btn btn-warning btn-lg me-3">
                <i class="fas fa-play me-2"></i>開始分析
            </button>
            <button id="refreshLayer2Data" class="btn btn-outline-warning btn-lg">
                <i class="fas fa-sync-alt me-2"></i>重新整理
            </button>
        </div>
    </div>
</div>

<!-- 載入狀態 -->
<div id="loadingLayer2" class="text-center mb-4" style="display: none;">
    <div class="spinner-border text-warning" role="status">
        <span class="visually-hidden">載入中...</span>
    </div>
    <p class="mt-2">正在收集第二層數據，請稍候...</p>
</div>

<!-- 摘要卡片 -->
<div id="summarySection" class="row mb-5" style="display: none;">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    第二層分析摘要
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="text-center">
                            <h4 id="marketSentiment" class="text-warning">-</h4>
                            <p class="small text-muted">市場情緒</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="text-center">
                            <h4 id="sectorTrend" class="text-info">-</h4>
                            <p class="small text-muted">產業趨勢</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="text-center">
                            <h4 id="upcomingEvents" class="text-success">-</h4>
                            <p class="small text-muted">即將事件</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="text-center">
                            <h4 id="successRate" class="text-primary">-</h4>
                            <p class="small text-muted">成功率</p>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="alert alert-info mb-0">
                            <strong>投資建議：</strong>
                            <span id="investmentAdvice">正在分析中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-5">
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-alt me-2"></i>
                    財經事件日曆
                </h5>
            </div>
            <div class="card-body">
                <p class="card-text">追蹤重要的財經事件和公告：</p>
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        聯準會會議和利率決議
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        重要經濟數據發布
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        企業財報季時程
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        地緣政治事件
                    </li>
                </ul>
                <div class="mt-3">
                    <button class="btn btn-warning btn-sm" onclick="loadEconomicCalendar()">
                        <i class="fas fa-calendar me-1"></i>查看事件
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    新聞情緒分析
                </h5>
            </div>
            <div class="card-body">
                <p class="card-text">分析市場新聞和社群媒體情緒：</p>
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        財經新聞情緒分析
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        社群媒體熱度追蹤
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        關鍵字趨勢分析
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        市場共識變化
                    </li>
                </ul>
                <div class="mt-3">
                    <button class="btn btn-info btn-sm" onclick="loadNewsSentiment()">
                        <i class="fas fa-newspaper me-1"></i>分析情緒
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-5">
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-industry me-2"></i>
                    產業輪動分析
                </h5>
            </div>
            <div class="card-body">
                <p class="card-text">識別產業趨勢和輪動機會：</p>
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        11大產業相對強弱
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        產業資金流向分析
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        主題投資機會
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        產業生命週期判斷
                    </li>
                </ul>
                <div class="mt-3">
                    <button class="btn btn-success btn-sm" onclick="loadSectorRotation()">
                        <i class="fas fa-industry me-1"></i>分析產業
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-search me-2"></i>
                    選股篩選器
                </h5>
            </div>
            <div class="card-body">
                <p class="card-text">基於事件和催化劑的選股工具：</p>
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        財報前後異動股票
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        新聞熱度飆升股票
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        分析師評級變化
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        內部人交易追蹤
                    </li>
                </ul>
                <div class="mt-3">
                    <button class="btn btn-primary btn-sm" onclick="loadStockScreener()">
                        <i class="fas fa-search me-1"></i>篩選股票
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 數據展示區域 -->
<div id="dataDisplaySection" style="display: none;">
    <!-- 財經事件日曆 -->
    <div id="economicCalendarSection" class="row mb-5" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>
                        財經事件日曆
                    </h5>
                </div>
                <div class="card-body">
                    <div id="economicCalendarContent">
                        <!-- 動態載入內容 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 新聞情緒分析 -->
    <div id="newsSentimentSection" class="row mb-5" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-newspaper me-2"></i>
                        新聞情緒分析
                    </h5>
                </div>
                <div class="card-body">
                    <div id="newsSentimentContent">
                        <!-- 動態載入內容 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 產業輪動分析 -->
    <div id="sectorRotationSection" class="row mb-5" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-industry me-2"></i>
                        產業輪動分析
                    </h5>
                </div>
                <div class="card-body">
                    <div id="sectorRotationContent">
                        <!-- 動態載入內容 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 選股篩選器 -->
    <div id="stockScreenerSection" class="row mb-5" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-search me-2"></i>
                        選股篩選結果
                    </h5>
                </div>
                <div class="card-body">
                    <div id="stockScreenerContent">
                        <!-- 動態載入內容 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 第二層數據收集
document.getElementById('collectLayer2Data').addEventListener('click', function() {
    collectLayer2Data();
});

document.getElementById('refreshLayer2Data').addEventListener('click', function() {
    collectLayer2Data();
});

function collectLayer2Data() {
    const loadingElement = document.getElementById('loadingLayer2');
    const summarySection = document.getElementById('summarySection');
    
    loadingElement.style.display = 'block';
    summarySection.style.display = 'none';
    
    fetch('/api/layer2/collect', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        loadingElement.style.display = 'none';
        
        if (data.success) {
            displayLayer2Summary(data.data);
            showToast('第二層數據收集完成！', 'success');
        } else {
            showToast('數據收集失敗：' + data.message, 'error');
        }
    })
    .catch(error => {
        loadingElement.style.display = 'none';
        console.error('Error:', error);
        showToast('網路錯誤，請重試', 'error');
    });
}

function displayLayer2Summary(data) {
    const summarySection = document.getElementById('summarySection');
    
    // 更新摘要數據
    document.getElementById('marketSentiment').textContent = data.summary.overall_sentiment || '-';
    document.getElementById('sectorTrend').textContent = data.summary.market_trend || '-';
    document.getElementById('upcomingEvents').textContent = data.summary.total_events || '0';
    document.getElementById('successRate').textContent = data.success_rate + '%' || '-';
    
    // 生成投資建議
    const sentiment = data.summary.overall_sentiment;
    const trend = data.summary.market_trend;
    let advice = '正在分析中...';
    
    if (sentiment === '正面' && trend.includes('科技')) {
        advice = '市場情緒正面，科技股主導，建議關注成長股機會';
    } else if (sentiment === '負面') {
        advice = '市場情緒偏負面，建議謹慎操作，關注防禦性產業';
    } else {
        advice = '市場情緒中性，建議均衡配置，等待明確信號';
    }
    
    document.getElementById('investmentAdvice').textContent = advice;
    
    summarySection.style.display = 'block';
}

// 載入各個子功能
function loadEconomicCalendar() {
    loadSubFunction('/api/layer2/economic-calendar', 'economicCalendarSection', 'economicCalendarContent', displayEconomicCalendar);
}

function loadNewsSentiment() {
    loadSubFunction('/api/layer2/news-sentiment', 'newsSentimentSection', 'newsSentimentContent', displayNewsSentiment);
}

function loadSectorRotation() {
    loadSubFunction('/api/layer2/sector-rotation', 'sectorRotationSection', 'sectorRotationContent', displaySectorRotation);
}

function loadStockScreener() {
    loadSubFunction('/api/layer2/stock-screener', 'stockScreenerSection', 'stockScreenerContent', displayStockScreener);
}

function loadSubFunction(apiUrl, sectionId, contentId, displayFunction) {
    const section = document.getElementById(sectionId);
    const content = document.getElementById(contentId);
    
    content.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p class="mt-2">載入中...</p></div>';
    section.style.display = 'block';
    document.getElementById('dataDisplaySection').style.display = 'block';
    
    fetch(apiUrl)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayFunction(data.data, content);
        } else {
            content.innerHTML = '<div class="alert alert-danger">載入失敗：' + data.error + '</div>';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        content.innerHTML = '<div class="alert alert-danger">網路錯誤，請重試</div>';
    });
}

// 顯示各個功能的數據
function displayEconomicCalendar(data, container) {
    if (!data.events || data.events.length === 0) {
        container.innerHTML = '<div class="alert alert-info">目前沒有即將到來的重要事件</div>';
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>日期</th><th>事件</th><th>重要性</th><th>倒數天數</th></tr></thead><tbody>';
    
    data.events.forEach(event => {
        const importanceClass = event.importance === '高' ? 'danger' : event.importance === '中' ? 'warning' : 'info';
        html += `
            <tr>
                <td>${event.date}</td>
                <td>${event.event}</td>
                <td><span class="badge bg-${importanceClass}">${event.importance}</span></td>
                <td>${event.days_until} 天</td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function displayNewsSentiment(data, container) {
    let html = `
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="text-center">
                    <h4 class="text-${data.overall_sentiment === '正面' ? 'success' : data.overall_sentiment === '負面' ? 'danger' : 'warning'}">${data.overall_sentiment}</h4>
                    <p class="small text-muted">整體情緒</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center">
                    <h4>${data.average_score}</h4>
                    <p class="small text-muted">平均分數</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center">
                    <h4>${data.total_analyzed}</h4>
                    <p class="small text-muted">分析新聞數</p>
                </div>
            </div>
        </div>
    `;
    
    if (data.news && data.news.length > 0) {
        html += '<h6>最新新聞分析：</h6>';
        data.news.slice(0, 5).forEach(news => {
            const sentimentClass = news.sentiment === '正面' ? 'success' : news.sentiment === '負面' ? 'danger' : 'warning';
            html += `
                <div class="card mb-2">
                    <div class="card-body">
                        <h6 class="card-title">${news.title}</h6>
                        <p class="card-text small">${news.summary}</p>
                        <div class="d-flex justify-content-between">
                            <span class="badge bg-${sentimentClass}">${news.sentiment}</span>
                            <small class="text-muted">${news.ticker}</small>
                        </div>
                    </div>
                </div>
            `;
        });
    }
    
    container.innerHTML = html;
}

function displaySectorRotation(data, container) {
    if (!data.sectors || data.sectors.length === 0) {
        container.innerHTML = '<div class="alert alert-info">產業數據載入中...</div>';
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>產業</th><th>代碼</th><th>月績效</th><th>相對強弱</th><th>波動率</th></tr></thead><tbody>';
    
    data.sectors.forEach(sector => {
        const performanceClass = sector.relative_strength > 0 ? 'text-success' : 'text-danger';
        html += `
            <tr>
                <td>${sector.sector}</td>
                <td>${sector.symbol}</td>
                <td class="${sector.performance_1m > 0 ? 'text-success' : 'text-danger'}">${sector.performance_1m}%</td>
                <td class="${performanceClass}">${sector.relative_strength}%</td>
                <td>${sector.volatility}%</td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    
    if (data.analysis) {
        html += `
            <div class="mt-3">
                <h6>分析結果：</h6>
                <p><strong>市場趨勢：</strong>${data.analysis.trend}</p>
                <p><strong>表現最佳：</strong>${data.analysis.top_performing.join(', ')}</p>
                <p><strong>表現最差：</strong>${data.analysis.underperforming.join(', ')}</p>
                <p><strong>市場廣度：</strong>${data.analysis.market_breadth}</p>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

function displayStockScreener(data, container) {
    if (!data.stocks || data.stocks.length === 0) {
        container.innerHTML = '<div class="alert alert-info">沒有找到符合條件的股票</div>';
        return;
    }
    
    // 統計信息
    let html = `
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="text-center">
                    <h4 class="text-primary">${data.total_analyzed}</h4>
                    <p class="small text-muted">分析股票數</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h4 class="text-success">${data.strong_buy_recommendations || 0}</h4>
                    <p class="small text-muted">強烈買入</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h4 class="text-warning">${data.buy_recommendations}</h4>
                    <p class="small text-muted">買入推薦</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h4 class="text-info">${data.average_score || 0}</h4>
                    <p class="small text-muted">平均評分</p>
                </div>
            </div>
        </div>
    `;
    
    // 股票卡片展示
    html += '<div class="row">';
    
    data.stocks.forEach(stock => {
        const changeClass = stock.price_change_5d > 0 ? 'text-success' : stock.price_change_5d < 0 ? 'text-danger' : 'text-muted';
        const monthChangeClass = stock.price_change_1m > 0 ? 'text-success' : stock.price_change_1m < 0 ? 'text-danger' : 'text-muted';
        
        // 評分進度條
        const scorePercentage = (stock.score / (stock.max_score || 10)) * 100;
        let scoreColor = 'danger';
        if (scorePercentage >= 70) scoreColor = 'success';
        else if (scorePercentage >= 50) scoreColor = 'warning';
        else if (scorePercentage >= 30) scoreColor = 'info';
        
        html += `
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">${stock.symbol}</h6>
                            <small class="text-muted">${stock.name}</small>
                        </div>
                        <span class="badge bg-${stock.rec_color || 'secondary'}">${stock.recommendation}</span>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-6">
                                <strong>$${stock.current_price}</strong>
                                <br><small class="text-muted">當前價格</small>
                            </div>
                            <div class="col-6 text-end">
                                <span class="${changeClass}">${stock.price_change_5d > 0 ? '+' : ''}${stock.price_change_5d}%</span>
                                <br><small class="text-muted">5日漲跌</small>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-6">
                                <span class="${monthChangeClass}">${stock.price_change_1m > 0 ? '+' : ''}${stock.price_change_1m}%</span>
                                <br><small class="text-muted">月度表現</small>
                            </div>
                            <div class="col-6 text-end">
                                <span>${stock.market_cap_formatted || 'N/A'}</span>
                                <br><small class="text-muted">市值</small>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <small>評分</small>
                                <small>${stock.score}/${stock.max_score || 10}</small>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-${scoreColor}" style="width: ${scorePercentage}%"></div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <small class="text-muted">估值指標：</small>
                            <div class="row">
                                <div class="col-4">
                                    <small><strong>PE:</strong> ${stock.pe_ratio}</small>
                                </div>
                                <div class="col-4">
                                    <small><strong>PEG:</strong> ${stock.peg_ratio || 'N/A'}</small>
                                </div>
                                <div class="col-4">
                                    <small><strong>波動:</strong> ${stock.volatility || 'N/A'}%</small>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <small class="text-muted">推薦理由：</small>
                            <div class="mt-1">
                                ${stock.reasons.map(reason => `<span class="badge bg-light text-dark me-1 mb-1">${reason}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    // 如果有備註，顯示備註
    if (data.note) {
        html += `<div class="alert alert-info mt-3"><i class="fas fa-info-circle me-2"></i>${data.note}</div>`;
    }
    
    container.innerHTML = html;
}
</script>
{% endblock %} 