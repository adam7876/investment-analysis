{% extends "base.html" %}

{% block title %}儀表板 - 美股投資分析系統{% endblock %}

{% block extra_css %}
<style>
    .sentiment-gauge {
        position: relative;
        width: 200px;
        height: 100px;
        margin: 0 auto;
    }
    
    .data-card {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }
    
    .data-card.success { border-left-color: var(--success-color); }
    .data-card.warning { border-left-color: var(--warning-color); }
    .data-card.danger { border-left-color: var(--danger-color); }
    
    .metric-value {
        font-size: 2rem;
        font-weight: bold;
        color: var(--primary-color);
    }
    
    .trend-up { color: var(--success-color); }
    .trend-down { color: var(--danger-color); }
    .trend-neutral { color: var(--warning-color); }
    
    .analysis-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
    }
    
    .recommendation-card {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
    }
    
    .risk-indicator {
        display: inline-block;
        padding: 5px 15px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 0.9rem;
    }
    
    .risk-low { background-color: var(--success-color); color: white; }
    .risk-medium { background-color: var(--warning-color); color: white; }
    .risk-high { background-color: var(--danger-color); color: white; }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-1">
                    <i class="fas fa-tachometer-alt text-primary me-2"></i>
                    投資分析儀表板
                </h2>
                <p class="text-muted mb-0">第一層：總經與市場環境分析</p>
            </div>
            <div>
                <button class="btn btn-primary me-2" onclick="refreshData()">
                    <i class="fas fa-sync-alt me-1"></i>
                    重新整理
                </button>
                <button class="btn btn-outline-secondary" onclick="exportData()">
                    <i class="fas fa-download me-1"></i>
                    匯出報告
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 載入動畫 -->
<div id="loading-spinner" class="loading-spinner text-center mb-4">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">載入中...</span>
    </div>
    <p class="mt-2">正在收集最新數據...</p>
</div>

<!-- 主要指標卡片 -->
<div class="row mb-4" id="main-metrics" style="display: none;">
    <div class="col-md-3 mb-3">
        <div class="card data-card h-100">
            <div class="card-body text-center">
                <h6 class="card-title text-muted">市場情緒指數</h6>
                <div class="metric-value" id="fear-greed-value">--</div>
                <p class="card-text" id="fear-greed-sentiment">載入中...</p>
                <div class="sentiment-gauge">
                    <canvas id="sentiment-chart" width="200" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card data-card h-100">
            <div class="card-body text-center">
                <h6 class="card-title text-muted">失業率</h6>
                <div class="metric-value" id="unemployment-value">--</div>
                <p class="card-text">
                    <i class="fas fa-calendar me-1"></i>
                    <span id="unemployment-date">--</span>
                </p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card data-card h-100">
            <div class="card-body text-center">
                <h6 class="card-title text-muted">聯邦基金利率</h6>
                <div class="metric-value" id="fed-rate-value">--</div>
                <p class="card-text">
                    <i class="fas fa-calendar me-1"></i>
                    <span id="fed-rate-date">--</span>
                </p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card data-card h-100">
            <div class="card-body text-center">
                <h6 class="card-title text-muted">數據品質</h6>
                <div class="metric-value" id="data-quality">--</div>
                <p class="card-text" id="data-sources">--</p>
            </div>
        </div>
    </div>
</div>

<!-- 分析結果 -->
<div class="row mb-4" id="analysis-section" style="display: none;">
    <div class="col-md-8">
        <div class="analysis-section">
            <h5 class="mb-3">
                <i class="fas fa-brain text-primary me-2"></i>
                智能分析結果
            </h5>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <h6 class="fw-bold">經濟階段</h6>
                    <p class="mb-2" id="economic-phase">分析中...</p>
                    
                    <h6 class="fw-bold">風險等級</h6>
                    <span class="risk-indicator" id="risk-level">評估中</span>
                </div>
                
                <div class="col-md-6 mb-3">
                    <h6 class="fw-bold">關鍵因素</h6>
                    <ul class="list-unstyled" id="key-factors">
                        <li>載入中...</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="recommendation-card">
            <h5 class="mb-3">
                <i class="fas fa-lightbulb me-2"></i>
                投資建議
            </h5>
            <div class="h4 mb-3" id="investment-recommendation">
                分析中...
            </div>
            <small id="recommendation-note">
                基於當前市場環境的建議
            </small>
        </div>
    </div>
</div>

<!-- 詳細數據表格 -->
<div class="row" id="detailed-data" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>
                    詳細數據
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>數據源</th>
                                <th>指標</th>
                                <th>數值</th>
                                <th>日期</th>
                                <th>狀態</th>
                            </tr>
                        </thead>
                        <tbody id="data-table-body">
                            <tr>
                                <td colspan="5" class="text-center">載入中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 更新時間 -->
<div class="row mt-4">
    <div class="col-12 text-center">
        <small class="text-muted">
            <i class="fas fa-clock me-1"></i>
            最後更新：<span id="last-update-time">--</span>
        </small>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentData = null;
    let sentimentChart = null;
    
    // 頁面載入時自動獲取數據
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardData();
    });
    
    // 載入儀表板數據
    async function loadDashboardData() {
        try {
            toggleLoading(true);
            
            const response = await fetch('/api/layer1/summary');
            const result = await response.json();
            
            if (result.success) {
                currentData = result.data;
                updateDashboard(currentData);
                showNotification('數據載入成功', 'success');
            } else {
                showNotification('數據載入失敗：' + result.error, 'error');
            }
        } catch (error) {
            showNotification('系統錯誤：' + error.message, 'error');
        } finally {
            toggleLoading(false);
            showDashboardSections();
        }
    }
    
    // 重新整理數據
    async function refreshData() {
        try {
            showNotification('開始收集最新數據...', 'info');
            
            const response = await fetch('/api/layer1/collect', {
                method: 'POST'
            });
            const result = await response.json();
            
            if (result.success) {
                currentData = result.data;
                updateDashboard(currentData);
                showNotification('數據更新成功', 'success');
            } else {
                showNotification('數據更新失敗：' + result.error, 'error');
            }
        } catch (error) {
            showNotification('系統錯誤：' + error.message, 'error');
        }
    }
    
    // 更新儀表板顯示
    function updateDashboard(data) {
        // 更新主要指標
        updateMainMetrics(data);
        
        // 更新分析結果
        updateAnalysisSection(data);
        
        // 更新詳細數據表格
        updateDetailedTable(data);
        
        // 更新時間
        document.getElementById('last-update-time').textContent = formatDate(data.timestamp);
    }
    
    // 更新主要指標
    function updateMainMetrics(data) {
        const summary = data.summary || {};
        
        // 市場情緒指數
        if (summary.market_sentiment) {
            const parts = summary.market_sentiment.split(' ');
            const value = parts[0];
            const sentiment = parts.slice(1).join(' ').replace(/[()]/g, '');
            
            document.getElementById('fear-greed-value').textContent = value;
            document.getElementById('fear-greed-sentiment').textContent = sentiment;
            
            // 創建情緒圖表
            createSentimentChart(parseInt(value));
        }
        
        // 數據品質
        const quality = data.data_quality || {};
        document.getElementById('data-quality').textContent = quality.success_rate || 'N/A';
        document.getElementById('data-sources').textContent = 
            `${quality.successful_sources || 0}/${quality.total_sources || 0} 數據源`;
    }
    
    // 更新分析結果
    function updateAnalysisSection(data) {
        const summary = data.summary || {};
        
        // 經濟階段
        document.getElementById('economic-phase').textContent = 
            summary.economic_phase || '數據不足';
        
        // 投資建議
        document.getElementById('investment-recommendation').textContent = 
            summary.investment_recommendation || '等待分析';
        
        // 風險等級
        const riskElement = document.getElementById('risk-level');
        const riskLevel = summary.risk_level || 'Unknown';
        riskElement.textContent = riskLevel;
        
        // 設置風險等級樣式
        riskElement.className = 'risk-indicator';
        if (riskLevel.includes('High')) {
            riskElement.classList.add('risk-high');
        } else if (riskLevel.includes('Medium')) {
            riskElement.classList.add('risk-medium');
        } else {
            riskElement.classList.add('risk-low');
        }
    }
    
    // 更新詳細數據表格
    function updateDetailedTable(data) {
        const tbody = document.getElementById('data-table-body');
        tbody.innerHTML = '';
        
        if (!data.data_quality || !data.data_quality.available_data) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">暫無數據</td></tr>';
            return;
        }
        
        const sources = data.data_quality.available_data;
        sources.forEach(source => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><span class="badge bg-primary">${source}</span></td>
                <td>各項指標</td>
                <td>已收集</td>
                <td>${formatDate(data.timestamp)}</td>
                <td><span class="status-indicator status-success"></span>正常</td>
            `;
            tbody.appendChild(row);
        });
    }
    
    // 創建情緒圖表
    function createSentimentChart(value) {
        const canvas = document.getElementById('sentiment-chart');
        const ctx = canvas.getContext('2d');
        
        // 清除之前的圖表
        if (sentimentChart) {
            sentimentChart.destroy();
        }
        
        // 創建半圓形儀表
        sentimentChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [value, 100 - value],
                    backgroundColor: [
                        value <= 25 ? '#e74c3c' :
                        value <= 45 ? '#f39c12' :
                        value <= 55 ? '#95a5a6' :
                        value <= 75 ? '#f39c12' : '#e74c3c',
                        '#ecf0f1'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                circumference: Math.PI,
                rotation: Math.PI,
                cutout: '70%',
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        enabled: false
                    }
                },
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }
    
    // 顯示儀表板各區塊
    function showDashboardSections() {
        document.getElementById('main-metrics').style.display = 'flex';
        document.getElementById('analysis-section').style.display = 'flex';
        document.getElementById('detailed-data').style.display = 'block';
        
        // 添加淡入動畫
        document.getElementById('main-metrics').classList.add('fade-in');
        document.getElementById('analysis-section').classList.add('fade-in');
        document.getElementById('detailed-data').classList.add('fade-in');
    }
    
    // 匯出報告
    function exportData() {
        if (!currentData) {
            showNotification('暫無數據可匯出', 'warning');
            return;
        }
        
        const dataStr = JSON.stringify(currentData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `investment_analysis_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        
        showNotification('報告已匯出', 'success');
    }
</script>
{% endblock %} 